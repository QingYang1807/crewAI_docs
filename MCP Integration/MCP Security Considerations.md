# MCP 安全考虑因素

> 了解在将 MCP 服务器与您的 CrewAI 代理集成时的重要安全最佳实践。

## 概述

<Warning>
  MCP 安全最关键的方面是**信任**。您应该**仅**将您的 CrewAI 代理连接到您完全信任的 MCP 服务器。
</Warning>

在将像 MCP（模型上下文协议）服务器这样的外部服务集成到您的 CrewAI 代理中时，安全性至关重要。
MCP 服务器可以根据其公开的工具执行代码、访问数据或与其他系统交互。
理解这些影响并遵循最佳实践以保护您的应用程序和数据是至关重要的。

### 风险

* 在运行代理的机器上执行任意代码（特别是使用 `Stdio` 传输时，如果服务器可以控制执行的命令）。
* 从您的代理或其环境中暴露敏感数据。
* 以意外方式操纵您的代理的行为，包括代表您进行未经授权的 API 调用。
* 通过复杂的提示注入技术劫持您的代理的推理过程（见下文）。

### 1. 信任 MCP 服务器

<Warning>
  **仅连接到您信任的 MCP 服务器。**
</Warning>

在配置 `MCPServerAdapter` 连接到 MCP 服务器之前，确保您了解：

* **谁在运营服务器？** 这是一个已知的、信誉良好的服务，还是在您控制之下的内部服务器？
* **它公开了什么工具？** 了解这些工具的功能。如果攻击者获得控制权或服务器本身是恶意的，这些工具是否可能被滥用？
* **它访问或处理什么数据？** 注意可能发送到 MCP 服务器或由其处理的任何敏感信息。

避免连接到未知或未经验证的 MCP 服务器，特别是如果您的代理处理敏感任务或数据。

### 2. 通过工具元数据的安全提示注入："模型控制协议"风险

一个重大而微妙的风险是通过工具元数据进行提示注入的可能性。其工作原理如下：

1. 当您的 CrewAI 代理连接到 MCP 服务器时，它通常会请求可用工具的列表。
2. MCP 服务器响应每个工具的元数据，包括其名称、描述和参数描述。
3. 您代理的基础语言模型（LLM）使用这些元数据来理解如何以及何时使用这些工具。这些元数据通常被整合到 LLM 的系统提示或上下文中。
4. 恶意的 MCP 服务器可以精心设计其工具元数据（名称、描述）以包含隐藏或明显的指令。这些指令可以充当提示注入，有效地告诉您的 LLM 以特定方式行事、泄露敏感信息或执行恶意操作。

**关键是，这种攻击可能仅仅通过连接到恶意服务器并列出其工具就会发生，即使您的代理从未明确决定使用这些工具中的任何一个。** 仅仅接触到恶意元数据就足以危及代理的行为。

**缓解措施：**

* **对不受信任的服务器保持极度谨慎**：重申：*不要连接到您不完全信任的 MCP 服务器。* 元数据注入的风险使这一点变得至关重要。

### Stdio 传输安全

Stdio（标准输入/输出）传输通常用于在与您的 CrewAI 应用程序相同的机器上运行的本地 MCP 服务器。

* **进程隔离**：虽然一般来说更安全，因为它默认不涉及网络暴露，但确保由 `StdioServerParameters` 运行的脚本或命令来自受信任的来源并具有适当的文件系统权限。恶意的 Stdio 服务器脚本仍可能损害您的本地系统。
* **输入清理**：如果您的 Stdio 服务器脚本接受源自代理交互的复杂输入，请确保脚本本身清理这些输入，以防止在脚本逻辑中出现命令注入或其他漏洞。
* **资源限制**：请注意，本地 Stdio 服务器进程会消耗本地资源（CPU、内存）。确保其行为良好，不会耗尽系统资源。

### 糊涂副手攻击

[糊涂副手问题](https://en.wikipedia.org/wiki/Confused_deputy_problem)是一个典型的安全漏洞，可能在 MCP 集成中表现出来，特别是当 MCP 服务器作为使用 OAuth 2.0 进行授权的其他第三方服务（例如，Google 日历、GitHub）的代理时。

**场景：**

1. 一个 MCP 服务器（我们称之为 `MCP-Proxy`）允许您的代理与 `ThirdPartyAPI` 交互。
2. `MCP-Proxy` 在与 `ThirdPartyAPI` 的授权服务器通信时使用自己单一的静态 `client_id`。
3. 作为用户，您合法地授权 `MCP-Proxy` 代表您访问 `ThirdPartyAPI`。在此过程中，`ThirdPartyAPI` 的认证服务器可能会在您的浏览器中设置一个 cookie，表示您同意 `MCP-Proxy` 的 `client_id`。
4. 攻击者精心制作一个恶意链接。此链接启动与 `MCP-Proxy` 的 OAuth 流程，但旨在欺骗 `ThirdPartyAPI` 的认证服务器。
5. 如果您点击此链接，并且 `ThirdPartyAPI` 的认证服务器看到您对 `MCP-Proxy` 的 `client_id` 的现有同意 cookie，它可能会跳过再次征求您的同意。
6. 然后，`MCP-Proxy` 可能被欺骗将授权代码（用于 `ThirdPartyAPI`）转发给攻击者，或者攻击者可以使用冒充您给 `MCP-Proxy` 的 MCP 授权代码。

**缓解措施（主要针对 MCP 服务器开发者）：**

* 为下游服务使用静态客户端 ID 的 MCP 代理服务器**必须**在启动与第三方服务的 OAuth 流程**之前**，获得连接到它们的*每个客户端应用程序或代理*的明确用户同意。这意味着 `MCP-Proxy` 本身应该显示一个同意屏幕。

**CrewAI 用户影响：**

* 如果 MCP 服务器将您重定向进行多次 OAuth 认证，请保持谨慎，特别是如果这看起来出乎意料，或者所请求的权限过于宽泛。
* 优先选择明确划清自己身份与其可能代理的第三方服务之间界限的 MCP 服务器。

### 远程传输安全（SSE 和可流式 HTTP）

当通过服务器发送事件（SSE）或可流式 HTTP 连接到远程 MCP 服务器时，标准的网络安全实践至关重要。

### SSE 安全考虑

### a. DNS 重绑定攻击（特别是对 SSE）

<Critical>
  **防范 DNS 重绑定攻击。**
</Critical>

DNS 重绑定允许攻击者控制的网站绕过同源策略，并向用户本地网络（例如 `localhost`）或内网上的服务器发出请求。如果您在本地运行 MCP 服务器（例如用于开发）并且代理在类似浏览器的环境中运行（尽管对于典型的 CrewAI 后端设置不太常见），或者如果 MCP 服务器在内网上，这尤其危险。

**MCP 服务器实现者的缓解策略：**

* **验证 `Origin` 和 `Host` 头**：MCP 服务器（特别是 SSE 服务器）应该验证 `Origin` 和/或 `Host` HTTP 头，以确保请求来自预期的域/客户端。
* **绑定到 `localhost` (127.0.0.1)**：在本地为开发运行 MCP 服务器时，将它们绑定到 `127.0.0.1` 而不是 `0.0.0.0`。这样可以防止它们从网络上的其他机器访问。
* **身份验证**：如果您的 MCP 服务器不打算供公共匿名访问，请要求对其所有连接进行身份验证。

### b. 使用 HTTPS

* **传输中数据加密**：始终对远程 MCP 服务器的 URL 使用 HTTPS（HTTP 安全）。这会加密您的 CrewAI 应用程序和 MCP 服务器之间的通信，防止窃听和中间人攻击。`MCPServerAdapter` 将遵循 URL 中提供的方案（`http` 或 `https`）。

### c. 令牌传递（反模式）

这主要是 MCP 服务器开发者的担忧，但了解它有助于选择安全的服务器。

"令牌传递"是指 MCP 服务器接受来自您的 CrewAI 代理的访问令牌（这可能是*不同*服务的令牌，比如 `ServiceA`），然后在不进行适当验证的情况下简单地将其传递给另一个下游 API（`ServiceB`）。具体来说，`ServiceB`（或 MCP 服务器本身）应该只接受明确为它们颁发的令牌（即令牌中的"受众"声明与服务器/服务匹配）。

**风险：**

* 绕过 MCP 服务器或下游 API 上的安全控制（如速率限制或细粒度权限）。
* 破坏审计跟踪和问责制。
* 允许滥用被盗的令牌。

**缓解措施（针对 MCP 服务器开发者）：**

* MCP 服务器**不得**接受不是明确为其颁发的令牌。它们必须验证令牌的受众声明。

**CrewAI 用户影响：**

* 虽然用户无法直接控制，但这强调了连接到遵循安全最佳实践的设计良好的 MCP 服务器的重要性。

#### 身份验证和授权

* **验证身份**：如果 MCP 服务器提供敏感工具或对私有数据的访问，它必须实现强大的身份验证机制来验证客户端（您的 CrewAI 应用程序）的身份。这可能涉及 API 密钥、OAuth 令牌或其他标准方法。
* **最小权限原则**：确保 `MCPServerAdapter`（如果有）使用的凭据仅具有访问所需工具的必要权限。

### d. 输入验证和清理

* **输入验证至关重要**：MCP 服务器**必须**在处理来自代理的输入或将其传递给工具**之前**严格验证所有输入。这是对许多常见漏洞的主要防御：
  * **命令注入：** 如果工具基于输入构建 shell 命令、SQL 查询或其他解释性语言语句，服务器必须仔细清理此输入，以防止恶意命令被注入和执行。
  * **路径遍历：** 如果工具基于输入参数访问文件，服务器必须验证和清理这些路径，以防止对未经授权的文件或目录的访问（例如，通过阻止 `../` 序列）。
  * **数据类型和范围检查：** 服务器必须确保输入数据符合预期的数据类型（例如，字符串、数字、布尔值）并在可接受的范围内或遵循定义的格式（例如，URL 的正则表达式）。
  * **JSON 模式验证：** 所有工具参数都应针对其定义的 JSON 模式进行严格验证。这有助于及早发现格式错误的请求。
* **客户端意识**：虽然服务器端验证是至关重要的，但作为 CrewAI 用户，请注意您的代理被构造发送给 MCP 工具的数据，特别是在与不太信任或新的 MCP 服务器交互时。

### e. 速率限制和资源管理

* **防止滥用**：MCP 服务器应实施速率限制以防止滥用，无论是故意的（拒绝服务攻击）还是无意的（例如，配置错误的代理发出过多请求）。
* **客户端重试**：如果预期出现瞬态网络问题或服务器速率限制，请在您的 CrewAI 任务中实施合理的重试逻辑，但避免可能加剧服务器负载的激进重试。

## 4. 安全 MCP 服务器实现建议（针对开发者）

如果您正在开发 CrewAI 代理可能连接的 MCP 服务器，除了上述要点外，还请考虑这些最佳实践：

* **遵循安全编码实践**：遵守您所选语言和框架的标准安全编码原则（例如，OWASP Top 10）。
* **最小权限原则**：确保运行 MCP 服务器的进程（特别是对于 `Stdio`）仅具有最小的必要权限。工具本身也应以执行其功能所需的最小权限运行。
* **依赖管理**：保持所有服务器端依赖项（包括操作系统包、语言运行时和第三方库）的最新状态，以修补已知漏洞。使用工具扫描易受攻击的依赖项。
* **安全默认值**：将您的服务器及其工具设计为默认安全。例如，可能有风险的功能应默认关闭或需要明确选择加入并带有明确警告。
* **工具的访问控制**：实施强大的机制来控制哪些经过身份验证和授权的代理或用户可以访问特定工具，特别是那些强大、敏感或产生成本的工具。
* **安全错误处理**：服务器不应向客户端暴露详细的内部错误消息、堆栈跟踪或调试信息，因为这些可能揭示内部工作原理或潜在漏洞。在服务器端全面记录错误以进行诊断。
* **全面的日志记录和监控**：实施对安全相关事件（例如，身份验证尝试、工具调用、错误、授权更改）的详细日志记录。监控这些日志以发现可疑活动或滥用模式。
* **遵守 MCP 授权规范**：如果实施身份验证和授权，请严格遵守 [MCP 授权规范](https://modelcontextprotocol.io/specification/draft/basic/authorization) 和相关的 [OAuth 2.0 安全最佳实践](https://datatracker.ietf.org/doc/html/rfc9700)。
* **定期安全审计**：如果您的 MCP 服务器处理敏感数据、执行关键操作或公开暴露，请考虑由合格的专业人员进行定期安全审计。

## 5. 进一步阅读

有关 MCP 安全性的更多详细信息，请参考官方文档：

* **[MCP 传输安全](https://modelcontextprotocol.io/docs/concepts/transports#security-considerations)**

通过理解这些安全考虑因素并实施最佳实践，您可以在您的 CrewAI 项目中安全地利用 MCP 服务器的强大功能。
这些绝不是详尽无遗的，但它们涵盖了最常见和最关键的安全问题。
威胁将继续演变，因此保持知情并相应调整您的安全措施非常重要。